<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognitive Ability Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
        }
        #config-page, #start-page, #test-page, #result-page, #loading-page {
            display: none;
        }
        img {
            max-width: 100vw; /* Adjust to use full viewport width */
            max-height: 100vh; /* Adjust to use full viewport height */
            object-fit: contain; /* Ensures image fits within bounds */
            display: block;
            margin: 0 auto;
        }
        button, select, input {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
        #error-message {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="config-page">
    <h1>Configuration</h1>
    <label for="image-count">Select number of images:</label>
    <select id="image-count">
        <option value="10">10</option>
        <option value="15" selected>15</option>
        <option value="20">20</option>
        <option value="25">25</option>
        <option value="30">30</option>
        <option value="35">35</option>
        <option value="40">40</option>
        <option value="45">45</option>
        <option value="50">50</option>
    </select>
    <br>
    <label for="save-results">Save results to .txt file?</label>
    <input type="checkbox" id="save-results">
    <br>
    <label for="user-name">Enter your name:</label>
    <input type="text" id="user-name" placeholder="Your name">
    
    <br>
    <span id="error-message"></span>
    <br>
    <button onclick="startConfig()">Start Test</button>
</div>

<div id="start-page">
    <h1>Welcome to the Cognitive Ability Test</h1>
    <p>Identify the emotion shown in each picture. You will be timed, and after the pictures, your results will be displayed.</p>
    <button onclick="startTest()">Start</button>
</div>

<div id="loading-page">
    <h1>Loading Images...</h1>
    <p>Please wait while we prepare the images for the test.</p>
</div>

<div id="test-page">
    <img id="emotion-image" src="" alt="Emotion Image">
    <div>
        <button onclick="submitAnswer('angry')">Angry</button>
        <button onclick="submitAnswer('disgusted')">Disgusted</button>
        <button onclick="submitAnswer('fearful')">Fearful</button>
        <button onclick="submitAnswer('happy')">Happy</button>
        <button onclick="submitAnswer('neutral')">Neutral</button>
        <button onclick="submitAnswer('sad')">Sad</button>
        <button onclick="submitAnswer('surprised')">Surprised</button>
    </div>
</div>

<div id="result-page">
    <h1>Results</h1>
    <p id="result-summary"></p>
    <button onclick="restartTest()">Restart</button>
</div>

<script>
    const imagesFolder = 'photos'; // Updated to reflect the correct folder name
    const emotions = ['angry', 'disgusted', 'fearful', 'happy', 'neutral', 'sad', 'surprised'];
    let totalImages = 15; // Default number of images
    let images = [];
    let currentIndex = 0;
    let correctAnswers = 0;
    let startTime, endTime;
    let timeTaken = [];
    let saveResults = false;
    let userName = '';

    window.onload = () => {
        document.getElementById('config-page').style.display = 'block';
    };

    const manifestPath = 'manifest.json';

    async function fetchImages() {
        document.getElementById('config-page').style.display = 'none';
        document.getElementById('loading-page').style.display = 'block';

        try {
            const response = await fetch(manifestPath);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const manifest = await response.json();
            const selectedFolders = Array.from({ length: totalImages }, () => emotions[Math.floor(Math.random() * emotions.length)]);
            let imageSet = new Set();

            console.log('Selected Folders:', selectedFolders);

            for (let emotion of selectedFolders) {
                const imagesList = manifest[emotion];
                if (imagesList && imagesList.length > 0) {
                    const randomIndex = Math.floor(Math.random() * imagesList.length);
                    const imagePath = `${imagesFolder}/${emotion}/${imagesList[randomIndex]}`;
                    console.log('Adding image path:', imagePath);
                    imageSet.add(imagePath);
                }
            }

            images = Array.from(imageSet).slice(0, totalImages);
            console.log('Selected images:', images);
            document.getElementById('loading-page').style.display = 'none';
            document.getElementById('test-page').style.display = 'block';
            showNextImage();
        } catch (error) {
            console.error('Error fetching images:', error);
        }
    }

    function startConfig() {
    // Retrieve and trim userName value
        const userNameInput = document.getElementById('user-name');
        console.log('User Name Input Element:', userNameInput); // Debugging line
        
        userName = userNameInput.value.trim();
        console.log('User Name Retrieved:', userName); // Debugging line
        
        totalImages = parseInt(document.getElementById('image-count').value, 10);
        saveResults = document.getElementById('save-results').checked;

        console.log('Configuration Settings:');
        console.log('Total Images:', totalImages);
        console.log('Save Results:', saveResults);
        console.log('User Name:', userName);

        if (saveResults && userName === '') {
            document.getElementById('error-message').textContent = 'Please enter a name so that your results can be saved. Thank you!';
            return;
        }

        document.getElementById('error-message').textContent = '';
        fetchImages();
    }


    function resetTest() {
        currentIndex = 0;
        correctAnswers = 0;
        timeTaken = [];
        userName = '';
        document.getElementById('user-name').value = '';
    }

    function showNextImage() {
        if (currentIndex < totalImages) {
            const imgElement = document.getElementById('emotion-image');
            imgElement.src = images[currentIndex];
            console.log('Showing image:', images[currentIndex]); // Debugging log
            imgElement.onerror = () => {
                console.error('Failed to load image:', imgElement.src);
                alert('Failed to load image: ' + imgElement.src);
            };
            startTime = new Date();
        } else {
            showResults();
        }
    }

    function submitAnswer(answer) {
        endTime = new Date();
        const timeDiff = (endTime - startTime) / 1000;
        timeTaken.push(timeDiff);

        const correctEmotion = images[currentIndex].match(/photos\/(angry|disgusted|fearful|happy|neutral|sad|surprised)/)[1];
        if (answer === correctEmotion) {
            correctAnswers++;
        }

        currentIndex++;
        showNextImage();
    }

    function showResults() {
        document.getElementById('test-page').style.display = 'none';
        document.getElementById('result-page').style.display = 'block';

        const totalTime = timeTaken.reduce((a, b) => a + b, 0);
        const avgTime = (totalTime / totalImages).toFixed(2);

        const resultSummary = `
            Total Correct: ${correctAnswers}
            Total Incorrect: ${totalImages - correctAnswers}
            Average Time per Image: ${avgTime} seconds
            Times for each image: ${timeTaken.map(time => time.toFixed(2)).join(', ')} seconds
        `;

        document.getElementById('result-summary').textContent = resultSummary;

        if (saveResults && userName !== '') {
            console.log('Calling saveResultsToFile function...');
            saveResultsToFile(resultSummary);
        } else {
            console.log('Not saving results. Save Results:', saveResults, 'User Name:', userName);
        }
    }


    function saveResultsToFile(resultSummary) {
        if (!userName) {
            console.error('User name is empty. Cannot save results.');
            return;
        }

        const fileName = `${userName}_facerecognitionresults.txt`; // Ensure file name is formatted correctly
        console.log('Preparing to save results to file:', fileName);

        try {
            const blob = new Blob([resultSummary], { type: 'text/plain' });
            console.log('Blob created:', blob);

            const url = URL.createObjectURL(blob);
            console.log('Object URL created:', url);

            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            console.log('Download link created:', a);

            document.body.appendChild(a);
            a.click();
            console.log('Download triggered.');

            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('Object URL revoked.');
        } catch (error) {
            console.error('Error saving results to file:', error);
        }
    }


    function restartTest() {
        document.getElementById('result-page').style.display = 'none';
        document.getElementById('config-page').style.display = 'block';
        resetTest();
    }
</script>

</body>
</html>
